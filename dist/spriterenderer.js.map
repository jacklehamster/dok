{"version":3,"sources":["../spriterenderer.js"],"names":["define","THREE","Utils","SpriteObject","SpriteSheet","Camera","turboSort","Shader","planeGeometry","PlaneBufferGeometry","pointCount","attributes","position","count","indices","index","array","spriteRenderers","uniforms","indexProcessor","SpriteRenderer","images","imageOrder","imageCount","mesh","createMesh","curvature","self","display","spriteObject","image","cut","visible","getCut","img","ready","SpriteImage","j","length","indexArray","quat","hasQuaternionArray","quaternionArray","getCameraQuaternionData","splatter","quatDirty","x","y","z","i","spotArray","positionDirty","size","vertices","v","verticesDirty","uv","uvDirty","tex","texDirty","light","lightDirty","push","prototype","destroy","destroySprite","render","updateGraphics","clear","Vector3","Float32Array","Uint16Array","zIndex","spriteRenderer","geometry","BufferGeometry","addAttribute","BufferAttribute","Mesh","MeshBasicMaterial","material","ShaderMaterial","texture","type","value","getTextures","vCam","getCamera","vertexShader","fragmentShader","transparent","depthWrite","depthTest","frustumCulled","sortImages","camera","distanceToManhattan","indexFunction","setIndexProcessor","fun","a","previousAttribute","copyArray","setDynamic","spot","quaternion","geo_quaternion","geo_spot","geo_pos","geo_tex","geo_light","geo_uv","geo_index","quatChanged","positionChanged","texChanged","verticesChanged","uvChanged","lightChanged","fill","drawRange","start","setDrawRange","needsUpdate","destroyEverything","dispose","onDestroy"],"mappings":"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","file":"spriterenderer.js","sourcesContent":["define([\n    'threejs',\n    'utils',\n    'spriteobject',\n    'spritesheet',\n    'camera',\n    'turbosort',\n    'shader',\n], function(THREE, Utils, SpriteObject, SpriteSheet, Camera, turboSort, Shader) {\n    'use strict';\n\n    const planeGeometry = new THREE.PlaneBufferGeometry(1, 1);\n    const pointCount = planeGeometry.attributes.position.count;\n    const indices = planeGeometry.index.array;\n    let spriteRenderers = [];\n    let uniforms = null;\n    let indexProcessor = function(){};\n\n    /**\n     *  CLASS DEFINITIONS\n     */\n\n    function SpriteRenderer() {\n        this.images = [];\n        this.imageOrder = [];\n        this.imageCount = 0;\n        this.mesh = createMesh(this);\n        this.curvature = 0;\n\n        const self = this;\n\n        this.display = function (spriteObject) {\n            let image = null;\n            const cut = spriteObject && spriteObject.visible\n                ? SpriteSheet.getCut(spriteObject.img) : null;\n            if (cut && cut.ready) {\n                const index = self.imageCount;\n                image = self.images[index];\n                if(!image) {\n                    image = self.images[index] = new SpriteImage();\n                    image.index = index;\n\n                    for (let j=0; j<indices.length; j++) {\n                        image.indexArray[j] = indices[j] + image.index*4;\n                    }\n                }\n\n                const quat = spriteObject.hasQuaternionArray\n                    ? spriteObject.quaternionArray : Camera.getCameraQuaternionData().array;\n                if (image.quaternionArray[0] !== quat[0]\n                    || image.quaternionArray[1] !== quat[1]\n                    || image.quaternionArray[2] !== quat[2]\n                    || image.quaternionArray[3] !== quat[3]\n                ) {\n                    quat.splatter(image.quaternionArray,0)\n                        .splatter(image.quaternionArray,4)\n                        .splatter(image.quaternionArray,8)\n                        .splatter(image.quaternionArray,12);\n                    image.quatDirty = true;\n                }\n\n                if (spriteObject.position.x !== image.position.x\n                    || spriteObject.position.y !== image.position.y\n                    || spriteObject.position.z !== image.position.z\n                ) {\n                    image.position.x = spriteObject.position.x;\n                    image.position.y = spriteObject.position.y;\n                    image.position.z = spriteObject.position.z;\n                    for(let i=0; i<4; i++) {\n                        image.spotArray[i*3] = image.position.x;\n                        image.spotArray[i*3+1] = image.position.y;\n                        image.spotArray[i*3+2] = image.position.z;\n                    }\n                    image.positionDirty = true;\n                }\n\n                if (spriteObject.size[0] !== image.size[0]\n                    || spriteObject.size[1] !== image.size[1]\n                    || spriteObject.size[2] !== image.size[2]\n                    || image.positionDirty\n                ) {\n                    image.size[0] = spriteObject.size[0];\n                    image.size[1] = spriteObject.size[1];\n                    image.size[2] = spriteObject.size[2];\n                    const vertices = planeGeometry.attributes.position.array;\n                    for(let v=0; v<vertices.length; v++) {\n                        image.vertices[v] = vertices[v] * spriteObject.size[v%3] + image.spotArray[v];\n                    }\n                    image.verticesDirty = true;\n                }\n\n                if(image.uv !== cut.uv) {\n                    image.uv = cut.uv;\n                    image.uvDirty = true;\n                }\n\n                if(image.tex !== cut.tex) {\n                    image.tex = cut.tex;\n                    image.texDirty = true;\n                }\n\n                if(image.light !== spriteObject.light) {\n                    image.light = spriteObject.light;\n                    image.lightDirty = true;\n                }\n                image.spriteObject = spriteObject;\n                self.imageOrder[index] = image;\n                self.imageCount++;\n            }\n            return image;\n        };\n\n        spriteRenderers.push(this);\n    }\n\n    SpriteRenderer.prototype.destroy = destroySprite;\n    SpriteRenderer.prototype.render = render;\n    SpriteRenderer.prototype.updateGraphics = updateGraphics;\n    SpriteRenderer.prototype.clear = clear;\n\n    function SpriteImage() {\n        this.position = new THREE.Vector3();\n        this.spotArray = new Float32Array(3 * pointCount);\n        this.size = new Float32Array(3);\n        this.vertices = new Float32Array(planeGeometry.attributes.position.array.length);\n        this.quaternionArray = new Float32Array(4 * pointCount);\n        this.indexArray = new Uint16Array(indices.length);\n    }\n    SpriteImage.prototype.index = 0;\n    SpriteImage.prototype.position = null;\n    SpriteImage.prototype.spotArray = null;\n    SpriteImage.prototype.indexArray = null;\n    SpriteImage.prototype.tex = -1;\n    SpriteImage.prototype.size = null;\n    SpriteImage.prototype.uv = null;\n    SpriteImage.prototype.vertices = null;\n    SpriteImage.prototype.light = 1;\n    SpriteImage.prototype.zIndex = 0;\n    SpriteImage.prototype.quaternionArray = null;\n    SpriteImage.prototype.positionDirty = true;\n    SpriteImage.prototype.verticesDirty = true;\n    SpriteImage.prototype.texDirty = true;\n    SpriteImage.prototype.uvDirty = true;\n    SpriteImage.prototype.lightDirty = true;\n    SpriteImage.prototype.quatDirty = true;\n\n    /**\n     *  FUNCTION DEFINITIONS\n     */\n\n    function clear() {\n        this.imageCount = 0;\n        SpriteObject.clear();\n    }\n\n    function createMesh(spriteRenderer) {\n        const geometry = new THREE.BufferGeometry();\n        const vertices = new Float32Array( [\n            -1.0, -1.0,  1.0,\n            1.0, -1.0,  1.0,\n            1.0,  1.0,  1.0,\n\n            1.0,  1.0,  1.0,\n            -1.0,  1.0,  1.0,\n            -1.0, -1.0,  1.0\n        ] );\n        geometry.addAttribute( 'position', new THREE.BufferAttribute( vertices, 3 ) );\n        const mesh = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial());\n\n        mesh.material = new THREE.ShaderMaterial( {\n            uniforms: uniforms = {\n                texture:  {\n                    type: 'tv',\n                    get value() { return SpriteSheet.getTextures(); },\n                },\n                vCam : {\n                    type: \"v3\",\n                    get value() { return Camera.getCamera().position; },\n                },\n                curvature: {\n                    type: \"f\",\n                    get value() { return spriteRenderer.curvature || 0; },\n                },\n            },\n            vertexShader: Shader.vertexShader,\n            fragmentShader: Shader.fragmentShader,\n            transparent:true,\n            depthWrite: false,\n            depthTest: true,\n        } );\n\n        mesh.frustumCulled = false;\n        return mesh;\n    }\n\n    function sortImages(images,count) {\n        const camera = Camera.getCamera();\n        for (let i = 0; i < count; i++) {\n            images[i].zIndex = -camera.position.distanceToManhattan(images[i].position);\n        }\n        indexProcessor(images, count);\n        turboSort(images,count,indexFunction);\n    }\n\n    function setIndexProcessor(fun) {\n        indexProcessor = fun ? fun : function(){};\n    }\n\n    function indexFunction(a) {\n        return a.zIndex;\n    }\n\n    function render() {\n        const imageCount = this.imageCount;\n        const pointCount = planeGeometry.attributes.position.count;\n        let previousAttribute;\n\n        const mesh = this.mesh;\n        const geometry = mesh.geometry;\n        if (!geometry.attributes.position || geometry.attributes.position.count < imageCount * pointCount) {\n            previousAttribute = geometry.attributes.position;\n            geometry.attributes.position = new THREE.BufferAttribute(\n                new Float32Array(imageCount * pointCount * 3), 3\n            );\n            if(previousAttribute)\n                geometry.attributes.position.copyArray(previousAttribute.array);\n            geometry.attributes.position.setDynamic(true);\n        }\n        if (!geometry.attributes.spot || geometry.attributes.spot.count < imageCount * pointCount) {\n            previousAttribute = geometry.attributes.spot;\n            geometry.attributes.spot = new THREE.BufferAttribute(\n                new Float32Array(imageCount * pointCount * 3), 3\n            );\n            if(previousAttribute)\n                geometry.attributes.spot.copyArray(previousAttribute.array);\n            geometry.attributes.spot.setDynamic(true);\n        }\n        if (!geometry.attributes.quaternion || geometry.attributes.quaternion.count < imageCount * pointCount) {\n            previousAttribute = geometry.attributes.quaternion;\n            geometry.attributes.quaternion = new THREE.BufferAttribute(\n                new Float32Array(imageCount * pointCount * 4), 4\n            );\n            if(previousAttribute)\n                geometry.attributes.quaternion.copyArray(previousAttribute.array);\n            geometry.attributes.quaternion.setDynamic(true);\n        }\n        if (!geometry.attributes.uv || geometry.attributes.uv.count < imageCount * pointCount) {\n            previousAttribute = geometry.attributes.uv;\n            geometry.attributes.uv = new THREE.BufferAttribute(\n                new Float32Array(imageCount * pointCount * 2), 2\n            );\n            if(previousAttribute)\n                geometry.attributes.uv.copyArray(previousAttribute.array);\n            geometry.attributes.uv.setDynamic(true);\n        }\n        if (!geometry.attributes.tex || geometry.attributes.tex.count < imageCount * pointCount) {\n            previousAttribute = geometry.attributes.tex;\n            geometry.attributes.tex = new THREE.BufferAttribute(\n                new Float32Array(imageCount * pointCount), 1\n            );\n            if(previousAttribute)\n                geometry.attributes.tex.copyArray(previousAttribute.array);\n            geometry.attributes.tex.setDynamic(true);\n        }\n        if (!geometry.attributes.light || geometry.attributes.light.count < imageCount * pointCount) {\n            previousAttribute = geometry.attributes.light;\n            geometry.attributes.light = new THREE.BufferAttribute(\n                new Float32Array(imageCount * pointCount), 1\n            );\n            if(previousAttribute)\n                geometry.attributes.light.copyArray(previousAttribute.array);\n            geometry.attributes.light.setDynamic(true);\n        }\n        if (!geometry.index || geometry.index.count < imageCount * planeGeometry.index.array.length) {\n            previousAttribute = geometry.index;\n            const indices = planeGeometry.index.array;\n            geometry.index = new THREE.BufferAttribute(new Uint16Array(imageCount * indices.length), 1);\n            if(previousAttribute)\n                geometry.index.copyArray(previousAttribute.array);\n            geometry.index.setDynamic(true);\n        }\n\n        sortImages(this.imageOrder, imageCount);\n    }\n\n    function updateGraphics() {\n        this.render();\n\n        const images = this.images;\n        const imageOrder = this.imageOrder;\n        const imageCount = this.imageCount;\n        const geometry = this.mesh.geometry;\n        const geo_quaternion = geometry.attributes.quaternion.array;\n        const geo_spot = geometry.attributes.spot.array;\n        const geo_pos = geometry.attributes.position.array;\n        const geo_tex = geometry.attributes.tex.array;\n        const geo_light = geometry.attributes.light.array;\n        const geo_uv = geometry.attributes.uv.array;\n        const geo_index = geometry.index.array;\n\n        let quatChanged = false;\n        let positionChanged = false;\n        let texChanged = false;\n        let verticesChanged = false;\n        let uvChanged = false;\n        let lightChanged = false;\n\n        for(let i=0;i<imageCount;i++) {\n            const image = images[i];\n            const index = image.index;\n\n            if (image.quatDirty) {\n                image.quaternionArray.splatter(geo_quaternion, index * 16);\n                image.quatDirty = false;\n                quatChanged = true;\n            }\n\n            if (image.positionDirty) {\n                image.spotArray.splatter(geo_spot, index * 12);\n                image.positionDirty = false;\n                positionChanged = true;\n            }\n\n            if (image.verticesDirty) {\n                image.vertices.splatter(geo_pos, index * 12);\n                image.verticesDirty = false;\n                verticesChanged = true;\n            }\n\n            if (image.uvDirty) {\n                image.uv.splatter(geo_uv, index * 8);\n                image.uvDirty = false;\n                uvChanged = true;\n            }\n\n            if (image.texDirty) {\n                geo_tex.fill(image.tex, index * 4, index * 4 + 4);\n                image.texDirty = false;\n                texChanged = true;\n            }\n\n            if (image.lightDirty) {\n                geo_light.fill(image.light, index * 4, index * 4 + 4);\n                image.lightDirty = false;\n                lightChanged = true;\n            }\n        }\n\n        for(let i=0;i<imageCount;i++) {\n            imageOrder[i].indexArray.splatter(geo_index, i * 6);\n        }\n\n        if(geometry.drawRange.start !== 0 || geometry.drawRange.count !== imageCount*planeGeometry.index.count) {\n            geometry.setDrawRange(0, imageCount*planeGeometry.index.count);\n        }\n\n        if(lightChanged) {\n            geometry.attributes.light.needsUpdate = true;\n        }\n        if(quatChanged) {\n            geometry.attributes.quaternion.needsUpdate = true;\n        }\n        if(positionChanged) {\n            geometry.attributes.spot.needsUpdate = true;\n        }\n        if(verticesChanged) {\n            geometry.attributes.position.needsUpdate = true;\n        }\n        if(texChanged) {\n            geometry.attributes.tex.needsUpdate = true;\n        }\n        if(uvChanged) {\n            geometry.attributes.uv.needsUpdate = true;\n        }\n        geometry.index.needsUpdate = true;\n        this.clear();\n    }\n\n    function destroyEverything() {\n        for(let i=0; i<spriteRenderers.length; i++) {\n            spriteRenderers[i].destroy();\n        }\n        spriteRenderers.length = 0;\n    }\n\n    function destroySprite() {\n        if(this.mesh) {\n            this.mesh.geometry.dispose();\n            this.mesh.material.dispose();\n        }\n        this.mesh = null;\n        this.images.length = 0;\n        this.imageCount = 0;\n    }\n\n    /**\n     *  PUBLIC DECLARATIONS\n     */\n    SpriteRenderer.setIndexProcessor = setIndexProcessor;\n    Utils.onDestroy(destroyEverything);\n\n    /**\n     *   PROCESSES\n     */\n\n\n    return SpriteRenderer;\n });\n"]}