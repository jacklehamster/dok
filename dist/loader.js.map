{"version":3,"sources":["../loader.js"],"names":["define","Utils","Loop","index","imageQueue","loadLimit","loading","loadingBar","visualProgress","onLoadCallback","loaded","loadTotal","setOnLoad","onLoad","document","body","removeChild","getLoadingBar","loadImage","url","image","Image","onload","event","call","checkLoad","crossOrigin","push","loadFile","loadAsync","result","length","src","getLoadingProgress","refreshLoadingBar","ctx","getContext","actualProgress","Math","max","removeLoop","fillRect","width","height","setTimeout","createElement","id","round","innerWidth","style","left","top","innerHeight","position","backgroundColor","border","fillStyle","addLoop","appendChild","destroyEverything","Loader","onDestroy"],"mappings":"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","file":"loader.js","sourcesContent":["define([ 'utils', 'loop' ], function(Utils, Loop) {\n    'use strict';\n\n    var index = 0;\n    var imageQueue = [];\n    var loadLimit = 3;\n    var loading = 0;\n    var loadingBar = null;\n    var visualProgress = 0;\n    var onLoadCallback = null;\n    var loaded = 0;\n    var loadTotal = 0;\n\n    /**\n     *  FUNCTION DEFINITIONS\n     */\n    function setOnLoad(onLoad) {\n        onLoadCallback = onLoad;\n        document.body.removeChild(getLoadingBar());\n    }\n\n    function loadImage(url,onLoad) {\n        var image = new Image();\n        image.onload = function(event) {\n            onLoad.call(image,event);\n            loading--;\n            loaded++;\n            checkLoad();\n        };\n        image.crossOrigin = '';\n        imageQueue.push({\n            image: image,\n            url: url,\n        });\n        loadTotal++;\n        checkLoad();\n        return image;\n    }\n\n    function loadFile(url,onLoad) {\n        loadTotal++;\n        Utils.loadAsync(url, function(result) {\n            loaded++;\n            onLoad(result);\n        });\n    }\n\n    function checkLoad() {\n        while(index<imageQueue.length && loading<loadLimit) {\n            imageQueue[index].image.src = imageQueue[index].url;\n            index++;\n            loading++;\n        }\n        if(index===imageQueue.length) {\n            index = 0;\n            imageQueue.length = 0;\n            loaded = 0;\n            loadTotal = 0;\n        }\n    }\n\n    function getLoadingProgress() {\n        return !loadTotal ? 1 : loaded / loadTotal;\n    }\n\n    function refreshLoadingBar() {\n        if(loadingBar) {\n            var ctx = loadingBar.getContext(\"2d\");\n            var actualProgress = getLoadingProgress();\n            visualProgress = Math.max(0,visualProgress + (actualProgress-visualProgress)/10);\n            if(actualProgress>=1) {\n                visualProgress = 1;\n                Loop.removeLoop(refreshLoadingBar);\n            }\n            ctx.fillRect(10,10,(loadingBar.width-20)*visualProgress,loadingBar.height-20);\n\n            if(actualProgress>=1) {\n                if(onLoadCallback) {\n                    setTimeout(onLoadCallback,100);\n                }\n            }\n        }\n    }\n\n    function getLoadingBar() {\n        if(!loadingBar) {\n            loadingBar = document.createElement(\"canvas\");\n            loadingBar.id = \"loading\";\n            loadingBar.width = Math.round((innerWidth*2)*2/3);\n            loadingBar.height = 50;\n            loadingBar.style.left = (innerWidth/2-loadingBar.width/4)+\"px\";\n            loadingBar.style.top = (innerHeight/2-loadingBar.height/4)+\"px\";\n            loadingBar.style.width = (loadingBar.width/2) + \"px\";\n            loadingBar.style.height = (loadingBar.height/2) + \"px\";\n            loadingBar.style.position = \"absolute\";\n            loadingBar.style.backgroundColor = \"white\";\n            loadingBar.style.border = \"10px double #00DDDD\";\n            var ctx = loadingBar.getContext(\"2d\");\n            ctx.fillStyle=\"#0066aa\";\n            Loop.addLoop(refreshLoadingBar);\n        }\n        document.body.appendChild(loadingBar);\n        return loadingBar;\n    }\n\n    function destroyEverything() {\n        imageQueue.length = 0;\n    }\n\n    /**\n     *  PUBLIC DECLARATIONS\n     */\n    function Loader() {\n    }\n\n    Loader.loadImage = loadImage;\n    Loader.loadFile = loadFile;\n    Loader.getLoadingProgress = getLoadingProgress;\n    Loader.getLoadingBar = getLoadingBar;\n    Loader.setOnLoad = setOnLoad;\n\n    Utils.onDestroy(destroyEverything);\n\n    return Loader;\n});\n"]}