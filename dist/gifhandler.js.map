{"version":3,"sources":["../gifhandler.js"],"names":["define","Utils","Loop","gifWorker","JSGif","gifs","isGif","src","block","split","slice","toLowerCase","indexOf","getGif","GifImage","self","gifInfo","currentFrame","maxFrameCompleted","renderTime","framesProcessed","header","frameInfos","canvases","callbacks","processNextFrame","frame","frameInfo","gce","img","canvas","document","createElement","style","position","left","top","width","height","ctx","getContext","webkitImageSmoothingEnabled","imageSmoothingEnabled","msImageSmoothingEnabled","drawImage","cData","getImageData","processNext","bind","send","putImageData","ready","hdr","length","push","cycleTime","currentIndex","delayTime","eof","loadAsync","content","parseGIF","Stream","prototype","getFrame","GifImage_getFrame","time","totalAnimationTime","Math","floor","min","destroyEverything","GifHandler","onDestroy"],"mappings":"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","file":"gifhandler.js","sourcesContent":["define([\n    'utils',\n    'loop',\n    'gifworker',\n    'jsgif/gif',\n], function(Utils, Loop, gifWorker, JSGif) {\n    'use strict';\n\n    var gifs = {};\n\n    /**\n     *  CLASS DEFINITIONS\n     */\n\n    /**\n     *  FUNCTION DEFINITIONS\n     */\n    function isGif(src) {\n        return gifs[src] && gifs[src].block || src.split(\"?\")[0].slice(-4).toLowerCase() === \".gif\" || src.indexOf(\"data:image/gif;\") === 0;\n    }\n\n    function getGif(src) {\n        if (!gifs[src]) {\n            gifs[src] = new GifImage(src);\n        }\n        return gifs[src];\n    }\n\n    function GifImage(src) {\n        var self = this;\n\n        var gifInfo = {\n            currentFrame: 0,\n            maxFrameCompleted: 0,\n            renderTime: 0,\n            framesProcessed: 0,\n            header: null,\n            frameInfos: [],\n            block: null,\n            canvases: [],\n            callbacks: [],\n            processNextFrame: function() {\n                var frame = this.framesProcessed;\n                var frameInfo = this.frameInfos[frame];\n\n                if(frameInfo && frameInfo.gce && frameInfo.img && this.header) {\n                    var canvas = document.createElement(\"canvas\");\n                    canvas.style.position = \"absolute\";\n                    canvas.style.left = 0;\n                    canvas.style.top = 0;\n                    canvas.width = this.header.width;\n                    canvas.height = this.header.height;\n                    var ctx = canvas.getContext(\"2d\");\n                    ctx.webkitImageSmoothingEnabled = false;\n                    ctx.imageSmoothingEnabled = false;\n                    ctx.msImageSmoothingEnabled = false;\n\n                    this.canvases[frame] = canvas;\n                    if(frame>0) { //  copy previous frame. That's how gifs work\n                        ctx.drawImage(this.canvases[frame-1], 0, 0);\n                    }\n\n                    var cData = ctx.getImageData(0,0,canvas.width,canvas.height);\n\n                    var self = this;\n                    var processNext = this.processNextFrame.bind(this);\n                    gifWorker.send(frameInfo, cData, this.header, function(cData, frameInfo) {\n                        ctx.putImageData(cData, 0, 0);\n                        if(self.callbacks[frameInfo.frame]) {\n                            self.callbacks[frameInfo.frame]();\n                        }\n                        self.maxFrameCompleted = frameInfo.frame;\n                        self.frameInfos[frameInfo.frame].ready = true;\n                        processNext();\n                    });\n                    this.currentFrame = this.framesProcessed;\n                    this.framesProcessed++;\n//                    document.body.appendChild(canvas);\n                }\n            },\n            hdr: function (hdr) {\n                this.header = hdr;\n                self.width = this.header.width;\n                self.height = this.header.height;\n            },\n            gce: function (gce) {\n                if(this.frameInfos.length==0 || this.frameInfos[this.frameInfos.length-1].gce) {\n                    this.frameInfos.push({\n                        gce:null,\n                        cycleTime:null,\n                        img:null,\n                        frame: this.frameInfos.length,\n                        ready: false,\n                    });\n                }\n                var currentIndex = this.frameInfos.length-1;\n                this.frameInfos[currentIndex].gce = gce;\n                if(!gce.delayTime) {\n                    gce.delayTime = 1;\n                }\n                this.frameInfos[currentIndex].cycleTime = gce.delayTime * 10\n                    + (currentIndex === 0 ? 0 : this.frameInfos[currentIndex-1].cycleTime);\n                this.processNextFrame();\n            },\n            img: function(img) {\n                if(this.frameInfos.length===0 || this.frameInfos[this.frameInfos.length-1].img) {\n                    this.frameInfos.push({});\n                }\n                this.frameInfos[this.frameInfos.length-1].img = img;\n                this.processNextFrame();\n            },\n            eof: function(block) {\n                this.block = block;\n                this.processNextFrame();\n            }\n        };\n\n        Utils.loadAsync(src, function(content) {\n            JSGif.parseGIF(new JSGif.Stream(content), gifInfo);\n        }, true);\n\n        this.frameInfos = gifInfo.frameInfos;\n        this.canvases = gifInfo.canvases;\n        this.callbacks = gifInfo.callbacks;\n        this.gifInfo = gifInfo;\n    }\n    GifImage.prototype.width = 0;\n    GifImage.prototype.height = 0;\n    GifImage.prototype.frameInfos = [];\n    GifImage.prototype.canvases = [];\n    GifImage.prototype.callbacks = [];\n    GifImage.prototype.gifInfo = null;\n    GifImage.prototype.getFrame = GifImage_getFrame;\n\n    function GifImage_getFrame() {\n        var gifInfo = this.gifInfo;\n        if(gifInfo.block && Loop.time > gifInfo.renderTime) {\n            gifInfo.currentFrame = (gifInfo.currentFrame+1) % this.frameInfos.length;\n            var totalAnimationTime = this.frameInfos[this.frameInfos.length-1].cycleTime;\n            gifInfo.renderTime = Math.floor(Loop.time / totalAnimationTime) * totalAnimationTime\n                + this.frameInfos[gifInfo.currentFrame].cycleTime;\n        }\n        return Math.min(gifInfo.currentFrame,gifInfo.maxFrameCompleted);\n    }\n\n    function destroyEverything() {\n        gifs = {};\n    }\n\n    /**\n     *  PUBLIC DECLARATIONS\n     */\n    function GifHandler() {\n    }\n\n    GifHandler.getGif = getGif;\n    GifHandler.isGif = isGif;\n    Utils.onDestroy(destroyEverything);\n\n    return GifHandler;\n\n });\n"]}