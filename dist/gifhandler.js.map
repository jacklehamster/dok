{"version":3,"sources":["../gifhandler.js"],"names":["define","Utils","Loop","gifWorker","JSGif","gifs","isGif","src","block","split","slice","toLowerCase","indexOf","getGif","GifImage","self","gifInfo","maxFrameCompleted","framesProcessed","header","frameInfos","canvases","callbacks","frameSlot","processNextFrame","frame","frameInfo","gce","img","canvas","document","createElement","style","position","left","top","width","height","ctx","getContext","webkitImageSmoothingEnabled","imageSmoothingEnabled","msImageSmoothingEnabled","drawImage","cData","getImageData","processNext","bind","send","putImageData","ready","hdr","length","push","cycleTime","currentIndex","delayTime","eof","loadAsync","content","parseGIF","Stream","prototype","getFrame","GifImage_getFrame","time","totalAnimationTime","cycle","timeInCycle","Math","floor","destroyEverything","GifHandler","onDestroy"],"mappings":";;AAAAA,OAAO,CACH,OADG,EAEH,MAFG,EAGH,WAHG,EAIH,WAJG,CAAP,EAKG,UAASC,KAAT,EAAgBC,IAAhB,EAAsBC,SAAtB,EAAiCC,KAAjC,EAAwC;AACvC;;AAEA,QAAIC,OAAO,EAAX;;AAEA;;;;AAIA;;;AAGA,aAASC,KAAT,CAAeC,GAAf,EAAoB;AAChB,eAAOF,KAAKE,GAAL,KAAaF,KAAKE,GAAL,EAAUC,KAAvB,IAAgCD,IAAIE,KAAJ,CAAU,GAAV,EAAe,CAAf,EAAkBC,KAAlB,CAAwB,CAAC,CAAzB,EAA4BC,WAA5B,OAA8C,MAA9E,IAAwFJ,IAAIK,OAAJ,CAAY,iBAAZ,MAAmC,CAAlI;AACH;;AAED,aAASC,MAAT,CAAgBN,GAAhB,EAAqB;AACjB,YAAI,CAACF,KAAKE,GAAL,CAAL,EAAgB;AACZF,iBAAKE,GAAL,IAAY,IAAIO,QAAJ,CAAaP,GAAb,CAAZ;AACH;AACD,eAAOF,KAAKE,GAAL,CAAP;AACH;;AAED,aAASO,QAAT,CAAkBP,GAAlB,EAAuB;AACnB,YAAIQ,OAAO,IAAX;;AAEA,YAAIC,UAAU;AACVC,+BAAmB,CADT;AAEVC,6BAAiB,CAFP;AAGVC,oBAAQ,IAHE;AAIVC,wBAAY,EAJF;AAKVZ,mBAAO,IALG;AAMVa,sBAAU,EANA;AAOVC,uBAAW,EAPD;AAQVC,uBAAW,IARD;AASVC,8BAAkB,4BAAW;AACzB,oBAAIC,QAAQ,KAAKP,eAAjB;AACA,oBAAIQ,YAAY,KAAKN,UAAL,CAAgBK,KAAhB,CAAhB;;AAEA,oBAAGC,aAAaA,UAAUC,GAAvB,IAA8BD,UAAUE,GAAxC,IAA+C,KAAKT,MAAvD,EAA+D;AAC3D,wBAAIU,SAASC,SAASC,aAAT,CAAuB,QAAvB,CAAb;AACAF,2BAAOG,KAAP,CAAaC,QAAb,GAAwB,UAAxB;AACAJ,2BAAOG,KAAP,CAAaE,IAAb,GAAoB,CAApB;AACAL,2BAAOG,KAAP,CAAaG,GAAb,GAAmB,CAAnB;AACAN,2BAAOO,KAAP,GAAe,KAAKjB,MAAL,CAAYiB,KAA3B;AACAP,2BAAOQ,MAAP,GAAgB,KAAKlB,MAAL,CAAYkB,MAA5B;AACA,wBAAIC,MAAMT,OAAOU,UAAP,CAAkB,IAAlB,CAAV;AACAD,wBAAIE,2BAAJ,GAAkC,KAAlC;AACAF,wBAAIG,qBAAJ,GAA4B,KAA5B;AACAH,wBAAII,uBAAJ,GAA8B,KAA9B;;AAEA,yBAAKrB,QAAL,CAAcI,KAAd,IAAuBI,MAAvB;AACA,wBAAGJ,QAAM,CAAT,EAAY;AAAE;AACVa,4BAAIK,SAAJ,CAAc,KAAKtB,QAAL,CAAcI,QAAM,CAApB,CAAd,EAAsC,CAAtC,EAAyC,CAAzC;AACH;;AAED,wBAAImB,QAAQN,IAAIO,YAAJ,CAAiB,CAAjB,EAAmB,CAAnB,EAAqBhB,OAAOO,KAA5B,EAAkCP,OAAOQ,MAAzC,CAAZ;;AAEA,wBAAItB,OAAO,IAAX;AACA,wBAAI+B,cAAc,KAAKtB,gBAAL,CAAsBuB,IAAtB,CAA2B,IAA3B,CAAlB;AACA5C,8BAAU6C,IAAV,CAAetB,SAAf,EAA0BkB,KAA1B,EAAiC,KAAKzB,MAAtC,EAA8C,UAASyB,KAAT,EAAgBlB,SAAhB,EAA2B;AACrEY,4BAAIW,YAAJ,CAAiBL,KAAjB,EAAwB,CAAxB,EAA2B,CAA3B;AACA,4BAAG7B,KAAKO,SAAL,CAAeI,UAAUD,KAAzB,CAAH,EAAoC;AAChCV,iCAAKO,SAAL,CAAeI,UAAUD,KAAzB;AACH;AACDV,6BAAKE,iBAAL,GAAyBS,UAAUD,KAAnC;AACAV,6BAAKK,UAAL,CAAgBM,UAAUD,KAA1B,EAAiCyB,KAAjC,GAAyC,IAAzC;AACAJ;AACH,qBARD;AASA,yBAAK5B,eAAL;AACpB;AACiB;AACJ,aA9CS;AA+CViC,iBAAK,aAAUA,IAAV,EAAe;AAChB,qBAAKhC,MAAL,GAAcgC,IAAd;AACApC,qBAAKqB,KAAL,GAAa,KAAKjB,MAAL,CAAYiB,KAAzB;AACArB,qBAAKsB,MAAL,GAAc,KAAKlB,MAAL,CAAYkB,MAA1B;AACH,aAnDS;AAoDVV,iBAAK,aAAUA,IAAV,EAAe;AAChB,oBAAG,KAAKP,UAAL,CAAgBgC,MAAhB,KAAyB,CAAzB,IAA8B,KAAKhC,UAAL,CAAgB,KAAKA,UAAL,CAAgBgC,MAAhB,GAAuB,CAAvC,EAA0CzB,GAA3E,EAAgF;AAC5E,yBAAKP,UAAL,CAAgBiC,IAAhB,CAAqB;AACjB1B,6BAAI,IADa;AAEjB2B,mCAAU,IAFO;AAGjB1B,6BAAI,IAHa;AAIjBH,+BAAO,KAAKL,UAAL,CAAgBgC,MAJN;AAKjBF,+BAAO;AALU,qBAArB;AAOH;AACD,oBAAIK,eAAe,KAAKnC,UAAL,CAAgBgC,MAAhB,GAAuB,CAA1C;AACA,qBAAKhC,UAAL,CAAgBmC,YAAhB,EAA8B5B,GAA9B,GAAoCA,IAApC;AACA,oBAAG,CAACA,KAAI6B,SAAR,EAAmB;AACf7B,yBAAI6B,SAAJ,GAAgB,CAAhB;AACH;AACD,qBAAKpC,UAAL,CAAgBmC,YAAhB,EAA8BD,SAA9B,GAA0C3B,KAAI6B,SAAJ,GAAgB,EAAhB,IACnCD,iBAAiB,CAAjB,GAAqB,CAArB,GAAyB,KAAKnC,UAAL,CAAgBmC,eAAa,CAA7B,EAAgCD,SADtB,CAA1C;AAEA,qBAAK9B,gBAAL;AACH,aAtES;AAuEVI,iBAAK,aAASA,IAAT,EAAc;AACf,oBAAG,KAAKR,UAAL,CAAgBgC,MAAhB,KAAyB,CAAzB,IAA8B,KAAKhC,UAAL,CAAgB,KAAKA,UAAL,CAAgBgC,MAAhB,GAAuB,CAAvC,EAA0CxB,GAA3E,EAAgF;AAC5E,yBAAKR,UAAL,CAAgBiC,IAAhB,CAAqB,EAArB;AACH;AACD,qBAAKjC,UAAL,CAAgB,KAAKA,UAAL,CAAgBgC,MAAhB,GAAuB,CAAvC,EAA0CxB,GAA1C,GAAgDA,IAAhD;AACA,qBAAKJ,gBAAL;AACH,aA7ES;AA8EViC,iBAAK,aAASjD,KAAT,EAAgB;AACjB,qBAAKA,KAAL,GAAaA,KAAb;AACA,qBAAKgB,gBAAL;AACH;AAjFS,SAAd;;AAoFAvB,cAAMyD,SAAN,CAAgBnD,GAAhB,EAAqB,UAASoD,OAAT,EAAkB;AACnCvD,kBAAMwD,QAAN,CAAe,IAAIxD,MAAMyD,MAAV,CAAiBF,OAAjB,CAAf,EAA0C3C,OAA1C;AACH,SAFD,EAEG,IAFH;;AAIA,aAAKI,UAAL,GAAkBJ,QAAQI,UAA1B;AACA,aAAKC,QAAL,GAAgBL,QAAQK,QAAxB;AACA,aAAKC,SAAL,GAAiBN,QAAQM,SAAzB;AACA,aAAKN,OAAL,GAAeA,OAAf;AACH;AACDF,aAASgD,SAAT,CAAmB1B,KAAnB,GAA2B,CAA3B;AACAtB,aAASgD,SAAT,CAAmBzB,MAAnB,GAA4B,CAA5B;AACAvB,aAASgD,SAAT,CAAmB1C,UAAnB,GAAgC,EAAhC;AACAN,aAASgD,SAAT,CAAmBzC,QAAnB,GAA8B,EAA9B;AACAP,aAASgD,SAAT,CAAmBxC,SAAnB,GAA+B,EAA/B;AACAR,aAASgD,SAAT,CAAmB9C,OAAnB,GAA6B,IAA7B;AACAF,aAASgD,SAAT,CAAmBC,QAAnB,GAA8BC,iBAA9B;;AAEA,aAASA,iBAAT,CAA2BC,IAA3B,EAAiC;AAC7B,YAAIjD,UAAU,KAAKA,OAAnB;;AAEA,YAAGA,QAAQR,KAAX,EAAkB;AACd,gBAAI0D,qBAAqB,KAAK9C,UAAL,CAAgB,KAAKA,UAAL,CAAgBgC,MAAhB,GAAuB,CAAvC,EAA0CE,SAAnE;AACA,gBAAG,CAACtC,QAAQO,SAAZ,EAAuB;AACnBP,wBAAQO,SAAR,GAAoB,EAApB;AACA,oBAAI4C,QAAQ,CAAZ;AACA,qBAAI,IAAI1C,QAAM,CAAd,EAAiBA,QAAM,KAAKL,UAAL,CAAgBgC,MAAvC,EAA+C3B,OAA/C,EAAwD;AACpD,2BAAMT,QAAQO,SAAR,CAAkB6B,MAAlB,GAA2B,KAAKhC,UAAL,CAAgBK,KAAhB,EAAuB6B,SAAxD,EAAmE;AAC/DtC,gCAAQO,SAAR,CAAkB8B,IAAlB,CAAuB5B,KAAvB;AACH;AACJ;AACJ;AACD,gBAAI2C,cAAcC,KAAKC,KAAL,CAAWL,OAAOC,kBAAlB,CAAlB;AACA,mBAAOlD,QAAQO,SAAR,CAAkB6C,WAAlB,CAAP;AACH;AACD,eAAOpD,QAAQC,iBAAf;AACH;;AAED,aAASsD,iBAAT,GAA6B;AACzBlE,eAAO,EAAP;AACH;;AAED;;;AAGA,aAASmE,UAAT,GAAsB,CACrB;;AAEDA,eAAW3D,MAAX,GAAoBA,MAApB;AACA2D,eAAWlE,KAAX,GAAmBA,KAAnB;AACAL,UAAMwE,SAAN,CAAgBF,iBAAhB;;AAEA,WAAOC,UAAP;AAEF,CAxKF","file":"gifhandler.js","sourcesContent":["define([\n    'utils',\n    'loop',\n    'gifworker',\n    'jsgif/gif',\n], function(Utils, Loop, gifWorker, JSGif) {\n    'use strict';\n\n    var gifs = {};\n\n    /**\n     *  CLASS DEFINITIONS\n     */\n\n    /**\n     *  FUNCTION DEFINITIONS\n     */\n    function isGif(src) {\n        return gifs[src] && gifs[src].block || src.split(\"?\")[0].slice(-4).toLowerCase() === \".gif\" || src.indexOf(\"data:image/gif;\") === 0;\n    }\n\n    function getGif(src) {\n        if (!gifs[src]) {\n            gifs[src] = new GifImage(src);\n        }\n        return gifs[src];\n    }\n\n    function GifImage(src) {\n        var self = this;\n\n        var gifInfo = {\n            maxFrameCompleted: 0,\n            framesProcessed: 0,\n            header: null,\n            frameInfos: [],\n            block: null,\n            canvases: [],\n            callbacks: [],\n            frameSlot: null,\n            processNextFrame: function() {\n                var frame = this.framesProcessed;\n                var frameInfo = this.frameInfos[frame];\n\n                if(frameInfo && frameInfo.gce && frameInfo.img && this.header) {\n                    var canvas = document.createElement(\"canvas\");\n                    canvas.style.position = \"absolute\";\n                    canvas.style.left = 0;\n                    canvas.style.top = 0;\n                    canvas.width = this.header.width;\n                    canvas.height = this.header.height;\n                    var ctx = canvas.getContext(\"2d\");\n                    ctx.webkitImageSmoothingEnabled = false;\n                    ctx.imageSmoothingEnabled = false;\n                    ctx.msImageSmoothingEnabled = false;\n\n                    this.canvases[frame] = canvas;\n                    if(frame>0) { //  copy previous frame. That's how gifs work\n                        ctx.drawImage(this.canvases[frame-1], 0, 0);\n                    }\n\n                    var cData = ctx.getImageData(0,0,canvas.width,canvas.height);\n\n                    var self = this;\n                    var processNext = this.processNextFrame.bind(this);\n                    gifWorker.send(frameInfo, cData, this.header, function(cData, frameInfo) {\n                        ctx.putImageData(cData, 0, 0);\n                        if(self.callbacks[frameInfo.frame]) {\n                            self.callbacks[frameInfo.frame]();\n                        }\n                        self.maxFrameCompleted = frameInfo.frame;\n                        self.frameInfos[frameInfo.frame].ready = true;\n                        processNext();\n                    });\n                    this.framesProcessed++;\n//                    document.body.appendChild(canvas);\n                }\n            },\n            hdr: function (hdr) {\n                this.header = hdr;\n                self.width = this.header.width;\n                self.height = this.header.height;\n            },\n            gce: function (gce) {\n                if(this.frameInfos.length===0 || this.frameInfos[this.frameInfos.length-1].gce) {\n                    this.frameInfos.push({\n                        gce:null,\n                        cycleTime:null,\n                        img:null,\n                        frame: this.frameInfos.length,\n                        ready: false,\n                    });\n                }\n                var currentIndex = this.frameInfos.length-1;\n                this.frameInfos[currentIndex].gce = gce;\n                if(!gce.delayTime) {\n                    gce.delayTime = 1;\n                }\n                this.frameInfos[currentIndex].cycleTime = gce.delayTime * 10\n                    + (currentIndex === 0 ? 0 : this.frameInfos[currentIndex-1].cycleTime);\n                this.processNextFrame();\n            },\n            img: function(img) {\n                if(this.frameInfos.length===0 || this.frameInfos[this.frameInfos.length-1].img) {\n                    this.frameInfos.push({});\n                }\n                this.frameInfos[this.frameInfos.length-1].img = img;\n                this.processNextFrame();\n            },\n            eof: function(block) {\n                this.block = block;\n                this.processNextFrame();\n            }\n        };\n\n        Utils.loadAsync(src, function(content) {\n            JSGif.parseGIF(new JSGif.Stream(content), gifInfo);\n        }, true);\n\n        this.frameInfos = gifInfo.frameInfos;\n        this.canvases = gifInfo.canvases;\n        this.callbacks = gifInfo.callbacks;\n        this.gifInfo = gifInfo;\n    }\n    GifImage.prototype.width = 0;\n    GifImage.prototype.height = 0;\n    GifImage.prototype.frameInfos = [];\n    GifImage.prototype.canvases = [];\n    GifImage.prototype.callbacks = [];\n    GifImage.prototype.gifInfo = null;\n    GifImage.prototype.getFrame = GifImage_getFrame;\n\n    function GifImage_getFrame(time) {\n        var gifInfo = this.gifInfo;\n\n        if(gifInfo.block) {\n            var totalAnimationTime = this.frameInfos[this.frameInfos.length-1].cycleTime;\n            if(!gifInfo.frameSlot) {\n                gifInfo.frameSlot = [];\n                var cycle = 0;\n                for(var frame=0; frame<this.frameInfos.length; frame++) {\n                    while(gifInfo.frameSlot.length < this.frameInfos[frame].cycleTime) {\n                        gifInfo.frameSlot.push(frame);\n                    }\n                }\n            }\n            var timeInCycle = Math.floor(time % totalAnimationTime);\n            return gifInfo.frameSlot[timeInCycle];\n        }\n        return gifInfo.maxFrameCompleted;\n    }\n\n    function destroyEverything() {\n        gifs = {};\n    }\n\n    /**\n     *  PUBLIC DECLARATIONS\n     */\n    function GifHandler() {\n    }\n\n    GifHandler.getGif = getGif;\n    GifHandler.isGif = isGif;\n    Utils.onDestroy(destroyEverything);\n\n    return GifHandler;\n\n });\n"]}