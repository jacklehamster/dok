{"version":3,"sources":["../gifworker.js"],"names":["define","Utils","Loop","IDGenerator","gifWorkerCallbacks","generator","GifWorker","onmessage","e","frameInfo","data","cData","header","id","plasterPixels","postMessage","buffer","img","gce","transparency","transparencyGiven","transparencyIndex","disposalMethod","ct","lctFlag","lct","gct","pixels","forEach","pixel","i","code","toString","substring","indexOf","lastIndexOf","blob","Blob","type","gifWorker","Worker","URL","createObjectURL","initializeGifWorker","recycle","sendToGifWorker","callback","get","send","destroyEverything","terminate","onDestroy"],"mappings":"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","file":"gifworker.js","sourcesContent":["define(['utils', 'loop', 'IDGenerator'], function(Utils, Loop, IDGenerator) {\n    let gifWorkerCallbacks = [];\n    let generator = new IDGenerator();\n\n    function GifWorker() {\n        onmessage = function(e) {\n            const frameInfo = e.data.frameInfo;\n            const cData = e.data.cData;\n            const header = e.data.header;\n            const id = e.data.id;\n\n            if(frameInfo && cData && header) {\n                plasterPixels(frameInfo, cData, header);\n            }\n            postMessage({id:id, cData: cData, frameInfo: frameInfo },[cData.data.buffer]);\n        };\n\n        function plasterPixels(frameInfo, cData, header) {\n            const img = frameInfo.img;\n            const gce = frameInfo.gce;\n            const transparency = gce.transparencyGiven ? gce.transparencyIndex : null;\n            const disposalMethod = gce.disposalMethod;\n\n            const ct = img.lctFlag ? img.lct : header.gct;\n\n            img.pixels.forEach(function(pixel, i) {\n                if (transparency !== pixel) { // This includes null, if no transparency was defined.\n                    cData.data[i * 4    ] = ct[pixel][0];\n                    cData.data[i * 4 + 1] = ct[pixel][1];\n                    cData.data[i * 4 + 2] = ct[pixel][2];\n                    cData.data[i * 4 + 3] = 255; // Opaque.\n                } else if (disposalMethod === 2 || disposalMethod === 3) {\n                    cData.data[i * 4 + 3] = 0; // Transparent.\n                }\n            });\n        }\n    }\n\n    let code = GifWorker.toString();\n    code = code.substring(code.indexOf(\"{\")+1, code.lastIndexOf(\"}\"));\n\n    const blob = new Blob([code], {type: \"application/javascript\"});\n    let gifWorker = new Worker(URL.createObjectURL(blob));\n\n    function initializeGifWorker(gifWorker) {\n        gifWorker.onmessage = function(e) {\n            gifWorkerCallbacks[e.data.id] (e.data.cData, e.data.frameInfo);\n            generator.recycle(e.data.id);\n            delete gifWorkerCallbacks[e.data.id];\n        }\n    }\n\n    function sendToGifWorker(frameInfo, cData, header, callback) {\n        const id = generator.get();\n        gifWorkerCallbacks[id] = callback;\n        gifWorker.postMessage({\n            frameInfo,\n            cData,\n            header,\n            id\n        }, [cData.data.buffer]);\n    }\n\n\n    initializeGifWorker(gifWorker);\n\n    gifWorker.send = sendToGifWorker;\n\n    function destroyEverything() {\n        if(gifWorker) {\n            gifWorker.terminate();\n        }\n        gifWorker = null;\n        gifWorkerCallbacks = null;\n        generator = null;\n    }\n\n    Utils.onDestroy(destroyEverything);\n\n    return gifWorker;\n});"]}