{"version":3,"sources":["../gifworker.js"],"names":["define","Utils","Loop","gifWorkerCallbacks","GifWorker","onmessage","e","frameInfo","data","cData","header","id","plasterPixels","postMessage","buffer","img","gce","transparency","transparencyGiven","transparencyIndex","disposalMethod","ct","lctFlag","lct","gct","pixels","forEach","pixel","i","code","toString","substring","indexOf","lastIndexOf","blob","Blob","type","gifWorker","Worker","URL","createObjectURL","initializeGifWorker","sendToGifWorker","callback","require","md5","Math","random","time","send","destroyEverything","terminate","onDestroy"],"mappings":"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","file":"gifworker.js","sourcesContent":["define(['utils', 'loop'], function(Utils, Loop) {\n    var gifWorkerCallbacks = {};\n\n    function GifWorker() {\n        onmessage = function(e) {\n            var frameInfo = e.data.frameInfo;\n            var cData = e.data.cData;\n            var header = e.data.header;\n            var id = e.data.id;\n\n            if(frameInfo && cData && header) {\n                plasterPixels(frameInfo, cData, header);\n            }\n            postMessage({id:id, cData: cData, frameInfo: frameInfo },[cData.data.buffer]);\n        };\n\n        function plasterPixels(frameInfo, cData, header) {\n            var img = frameInfo.img;\n            var gce = frameInfo.gce;\n            var transparency = gce.transparencyGiven ? gce.transparencyIndex : null;\n            var disposalMethod = gce.disposalMethod;\n\n            var ct = img.lctFlag ? img.lct : header.gct;\n\n            img.pixels.forEach(function(pixel, i) {\n                if (transparency !== pixel) { // This includes null, if no transparency was defined.\n                    cData.data[i * 4    ] = ct[pixel][0];\n                    cData.data[i * 4 + 1] = ct[pixel][1];\n                    cData.data[i * 4 + 2] = ct[pixel][2];\n                    cData.data[i * 4 + 3] = 255; // Opaque.\n                } else if (disposalMethod === 2 || disposalMethod === 3) {\n                    cData.data[i * 4 + 3] = 0; // Transparent.\n                }\n            });\n        }\n    }\n\n    var code = GifWorker.toString();\n    code = code.substring(code.indexOf(\"{\")+1, code.lastIndexOf(\"}\"));\n\n    var blob = new Blob([code], {type: \"application/javascript\"});\n    var gifWorker = new Worker(URL.createObjectURL(blob));\n\n    function initializeGifWorker(gifWorker) {\n        gifWorker.onmessage = function(e) {\n            gifWorkerCallbacks[e.data.id] (e.data.cData, e.data.frameInfo);\n            delete gifWorkerCallbacks[e.data.id];\n        }\n    }\n\n    function sendToGifWorker(frameInfo, cData, header, callback) {\n        require(['https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.7.0/js/md5.min.js'],\n            function(md5) {\n                const id = md5(Math.random()+\"\"+Loop.time);\n                gifWorkerCallbacks[id] = callback;\n                gifWorker.postMessage({\n                    frameInfo,\n                    cData,\n                    header,\n                    id\n                }, [cData.data.buffer]);\n            });\n    }\n\n\n    initializeGifWorker(gifWorker);\n\n    gifWorker.send = sendToGifWorker;\n\n    function destroyEverything() {\n        if(gifWorker) {\n            gifWorker.terminate();\n        }\n        gifWorker = null;\n        gifWorkerCallbacks = null;\n    }\n\n    Utils.onDestroy(destroyEverything);\n\n    return gifWorker;\n});"]}