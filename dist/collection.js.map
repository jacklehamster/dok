{"version":3,"sources":["../collection.js"],"names":["define","Utils","SpriteSheet","SpriteObject","Camera","nop","Collection","options","getSpriteFunction","forEach","getSprite","bind","type","handleError","prototype","pos","size","Grid_forEach","isCollection","callback","optionsX","x","optionsY","y","optionsWidth","width","optionsHeight","height","gridCount","count","length","i","Math","floor","c","obj","destroyEverything","spriteFace","spriteInfo","index","cellSize","light","img","spritesheet","sprite","create","cubeFaces","spriteCube","cube","faces","push","quaternions","southQuaternionArray","createSpriteCollection","spriteHash","areaSize","spriteRegistry","spriteFunction","spriteCount","SpriteInfo","uid","enterArea","leaveArea","areaId","getAreaHashId","area","move","getAreaHashIdWithArea","abs","selectedObj","getCamPos","camera","getCamera","xPos","position","yPos","round","spriteCollection","camPos","xArea","yArea","areaRange","a","Array","isArray","array","get","find","onDestroy"],"mappings":"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","file":"collection.js","sourcesContent":["define([\n    'utils',\n    'spritesheet',\n    'spriteobject',\n    'camera',\n], function(Utils, SpriteSheet, SpriteObject, Camera) {\n\n    'use strict';\n\n    function nop() {\n    }\n\n    function Collection(options, getSpriteFunction, forEach) {\n        this.options = options || {};\n        this.getSprite = getSpriteFunction ? getSpriteFunction : nop;\n        if(forEach) {\n            this.forEach = forEach.bind(this);\n        } else {\n            switch(this.options.type) {\n                case \"grid\":\n                    break;\n                default:\n                    Utils.handleError('Collection type not recognized');\n                    break;\n            }\n        }\n    }\n    Collection.prototype.pos = null;\n    Collection.prototype.size = null;\n    Collection.prototype.getSprite = nop;\n    Collection.prototype.forEach = Grid_forEach;\n    Collection.prototype.options = null;\n    Collection.prototype.getSprite = nop;\n    Collection.prototype.isCollection = true;\n\n    /**\n     *  FUNCTION DEFINITIONS\n     */\n    function Grid_forEach(callback) {\n        const optionsX = this.options.x;\n        const optionsY = this.options.y;\n        const optionsWidth = this.options.width;\n        const optionsHeight = this.options.height;\n        const gridCount = optionsWidth*optionsHeight;\n        const count = this.options.count || 1;\n        const length = gridCount*count;\n\n        for(let i=0; i<length; i++) {\n            const x = optionsX + i%optionsWidth;\n            const y = optionsY + Math.floor(i/optionsWidth) % optionsHeight;\n            const c = Math.floor(i / gridCount);\n            const obj = this.getSprite(x,y,c);\n            if(obj) {\n                if(obj.forEach) {\n                    obj.forEach(callback);\n                } else {\n                    callback(obj);\n                }\n            }\n        }\n    }\n\n    function destroyEverything() {\n    }\n\n    function spriteFace(spriteInfo) {\n        const x = spriteInfo.x;\n        const y = spriteInfo.y;\n        const index = spriteInfo.index;\n        const size = cellSize;\n        const light = 1;\n        const img = SpriteSheet.spritesheet.sprite[index];\n\n        return SpriteObject.create(\n            x*cellSize,y*cellSize,size/2,\n            size,size,\n            null,\n            light,\n            img\n        );\n    }\n\n    const cubeFaces = [];\n    function spriteCube(spriteInfo) {\n        cubeFaces.length = 0;\n\n        cube.faces.push(\n            SpriteObject.create(\n                x*cellSize,y*cellSize,size/2,\n                size,size,\n                Camera.quaternions.southQuaternionArray,\n                light,\n                img\n            )\n        );\n\n\n        return cubeFaces;\n    }\n\n    function createSpriteCollection(options) {\n        const spriteHash = []; spriteHash.length = 1000000;\n        const areaSize = 50;\n        const spriteRegistry = [];\n        const cellSize = 64;\n\n        let spriteFunction = function(spriteInfo) {\n            switch(spriteInfo.type) {\n                case 'face':\n                    return spriteFace(spriteInfo);\n                    break;\n                case 'cube':\n                    return spriteCube(spriteInfo);\n                    break;\n            }\n        };\n        if(options.spriteFunction) {\n            spriteFunction = options.spriteFunction;\n        }\n\n        let spriteCount = 0;\n        function SpriteInfo(x,y,index) {\n            this.uid = ++spriteCount;\n            spriteRegistry[this.uid] = this;\n            this.index = index;\n            this.enterArea(x,y);\n        }\n        SpriteInfo.prototype.leaveArea = function() {\n            const areaId = getAreaHashId(this.x,this.y);\n            const area = spriteHash[areaId];\n            if(area) {\n                if(area[this.uid])\n                    delete area[this.uid];\n            }\n        };\n        SpriteInfo.prototype.enterArea = function(x,y) {\n            this.x = x; this.y = y;\n            const areaId = getAreaHashId(this.x,this.y);\n            const area = spriteHash[areaId] || (spriteHash[areaId] = {});\n            area[this.uid] = this;\n        };\n        SpriteInfo.prototype.move = function(x,y) {\n            this.leaveArea();\n            this.enterArea(x,y);\n        };\n\n        function getAreaHashIdWithArea(x,y) {\n            return Math.abs(x*1331 ^ 312 + y*131) % spriteHash.length;\n        }\n\n        function getAreaHashId(x,y) {\n            x = Math.floor(x/areaSize);\n            y = Math.floor(y/areaSize);\n            return getAreaHashIdWithArea(x,y);\n        }\n\n        const selectedObj = { x: 0, y: 0};\n        function getCamPos() {\n            const camera = Camera.getCamera();\n            const xPos = camera.position.x;\n            const yPos = camera.position.y;\n\n            selectedObj.x = Math.round(xPos/cellSize);\n            selectedObj.y = Math.round(yPos/cellSize) + 6;\n            return selectedObj;\n        }\n\n        const spriteCollection = new Collection(\n            options,\n            spriteFunction,\n            function(callback) {\n                const camPos = getCamPos();\n                const xArea = Math.floor(camPos.x / areaSize);\n                const yArea = Math.floor(camPos.y / areaSize);\n                const areaRange = 1;\n                for(let y=yArea-areaRange;y<=yArea+areaRange;y++) {\n                    for(let x=xArea-areaRange;x<=xArea+areaRange;x++) {\n                        const areaId = getAreaHashIdWithArea(x,y);\n                        const area = spriteHash[areaId];\n                        if(area) {\n                            for(let a in area) {\n                                const sprite = area[a];\n                                const obj = this.getSprite(sprite);\n                                if(Array.isArray(obj)) {\n                                    obj.forEach(callback);\n                                } else {\n                                    callback(obj);\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        );\n        spriteCollection.create = function(x,y,index) {\n            return new SpriteInfo(x,y,index);\n        };\n        \n        var array = [];\n        spriteCollection.get = function(x,y) {\n            const areaId = getAreaHashId(x,y);\n            const area = spriteHash[areaId];\n            array.length = 0;\n            for(var i in area) {\n                var sprite = area[i];\n                if(Math.floor(sprite.x)===x && Math.floor(sprite.y)===y) {\n                    array.push(sprite);\n                }\n            }\n            return array.length ? array : null;\n        };\n        spriteCollection.find = function(uid) {\n            return spriteRegistry[uid];\n        };\n        return spriteCollection;\n    }\n\n    /**\n     *  PUBLIC DECLARATIONS\n     */\n    Collection.createSpriteCollection = createSpriteCollection;\n\n    /**\n     *   PROCESSES\n     */\n    Utils.onDestroy(destroyEverything);\n\n\n    return Collection;\n});\n"]}